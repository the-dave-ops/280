// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id              Int       @id @default(autoincrement()) @map("id")
  date            DateTime? @map("date")
  lastName        String?   @map("last_name") @db.VarChar(255)
  firstName       String?   @map("first_name") @db.VarChar(255)
  idNumber        String?   @unique @map("id_number") @db.VarChar(255)
  isPassport      Boolean   @default(false) @map("is_passport")
  birthDate       DateTime? @map("birth_date")
  street          String?   @db.VarChar(255)
  houseNumber     String?   @map("house_number") @db.VarChar(255)
  entrance        String?   @db.VarChar(255)
  apartment       Int?
  city            String?   @db.VarChar(255)
  phone           String?   @db.VarChar(255)
  mobile1         String?   @map("mobile_1") @db.VarChar(255)
  mobile2         String?   @map("mobile_2") @db.VarChar(255)
  healthFund      String?   @map("health_fund") @db.VarChar(255)
  category        String?   @db.VarChar(255)
  admissionDate   DateTime? @default(now()) @map("admission_date")
  employeeId      Int?      @map("employee_id")
  computerId      Int?      @map("computer_id")
  branchId        Int?      @map("branch_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  prescriptions   Prescription[]
  branch          Branch?   @relation(fields: [branchId], references: [id])
  
  // Related customers (family members, etc.)
  relatedTo       Customer[] @relation("CustomerRelations")
  relatedFrom     Customer[] @relation("CustomerRelations")

  @@map("customers")
  @@index([idNumber])
  @@index([lastName, firstName])
  @@index([phone])
  @@index([mobile1])
}

model Prescription {
  id                Int       @id @default(autoincrement()) @map("id")
  prescriptionNumber Int?    @unique @map("prescription_number") // Unique prescription number
  customerId        Int       @map("customer_id")
  type              String    @db.VarChar(50) // "מרחק", "קריאה", "עדשות מגע"
  date              DateTime  @default(now())
  
  // Prescription data for eyes
  r                 Float?    // Right eye sphere (SPH)
  l                 Float?    // Left eye sphere (SPH)
  cylR              Float?    @map("cyl_r") // Right cylinder (CYL)
  axR               Float?    @map("ax_r") // Right axis (Axis)
  cylL              Float?    @map("cyl_l") // Left cylinder (CYL)
  axL               Float?    @map("ax_l") // Left axis (Axis)
  
  // PRISM data (0.25-4.00 in steps of 0.25)
  prismR            Float?    @map("prism_r") // Right eye prism
  prismL            Float?    @map("prism_l") // Left eye prism
  
  // IN/OUT direction (in, out)
  inOutR            String?   @map("in_out_r") @db.VarChar(10) // Right eye in/out
  inOutL            String?   @map("in_out_l") @db.VarChar(10) // Left eye in/out
  
  // UP/DOWN direction (up, down)
  upDownR           String?   @map("up_down_r") @db.VarChar(10) // Right eye up/down
  upDownL           String?   @map("up_down_l") @db.VarChar(10) // Left eye up/down
  
  // PD - Pupillary Distance (20.00-40.00 in steps of 0.5)
  pdR               Float?    @map("pd_r") // Right eye PD
  pdL               Float?    @map("pd_l") // Left eye PD
  pdTotal           Float?    @map("pd_total") // Total PD (sum of pdR + pdL)
  
  // VA - Visual Acuity (6/5, 6/6, 6/7, 6/8, 6/9, 6/12, 6/18, 6/24, 6/36, 6/120)
  vaR               String?   @map("va_r") @db.VarChar(50) // Right eye visual acuity
  vaL               String?   @map("va_l") @db.VarChar(50) // Left eye visual acuity
  
  // Height (16.00-35.00 in steps of 0.5)
  heightR           Float?    @map("height_r") // Right eye height
  heightL           Float?    @map("height_l") // Left eye height
  
  // General lens data
  add               Float?    // Addition for reading
  index             String?   @default("1.56") @db.VarChar(50) // Index: 1.5, 1.56, 1.6, 1.67, 1.71, 1.74, 1.76, ייצור, סופר פלט, דק סכין
  color             String?   @db.VarChar(255) // Lens color
  colorPercentage   Float?    @map("color_percentage")
  
  // Frame data
  frameName         String?   @map("frame_name") @db.VarChar(255) // Frame name
  frameModel        String?   @map("frame_model") @db.VarChar(255) // Frame model
  frameColor        String?   @map("frame_color") @db.VarChar(255) // Frame color: אדום, ירוק, כחול, חום, ורוד, זהב מט, זהב מבריק, כסף מבריק, כסף מט, ניקל, אפור, טורקיז, כתום, שחור-לבן, שחור, שקוף, אחר
  frameSku          String?   @map("frame_sku") @db.VarChar(100) // Frame SKU (מק"ט)
  frameBridge       String?   @map("frame_bridge") @db.VarChar(50) // Frame bridge
  frameWidth        String?   @map("frame_width") @db.VarChar(50) // Frame width
  frameNotes        String?   @map("frame_notes") @db.Text // Frame notes
  healthFund        String?   @map("health_fund") @db.VarChar(255) // Health fund for prescription
  insuranceType     String?   @map("insurance_type") @db.VarChar(255) // Insurance type (e.g., "מושלם", "מכבי זהב")
  prescriptionSource String?  @map("prescription_source") @db.VarChar(100) // Source: "אופטומטריסט", "משקף קיים", "בדיקה חיצונית"
  price             Float?    @default(0)
  discountSource    String?   @map("discount_source") @db.VarChar(255)
  amountToPay       Float?    @default(0) @map("amount_to_pay")
  paid              Float?    @default(0)
  balance           Float?    @default(0)
  receiptNumber     String?   @map("receipt_number") @db.VarChar(255)
  campaign280       Boolean?  @default(false) @map("campaign_280")
  optometristId     Int?      @map("optometrist_id")
  branchId          Int?      @map("branch_id")
  source            String?   @db.VarChar(255)
  notes             String?   @db.Text
  updateDate        DateTime  @default(now()) @updatedAt @map("update_date")
  createdAt         DateTime  @default(now()) @map("created_at")

  customer          Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  optometrist       Optometrist?  @relation(fields: [optometristId], references: [id])
  branch            Branch?       @relation(fields: [branchId], references: [id])

  @@map("prescriptions")
  @@index([customerId])
  @@index([date])
  @@index([type])
  @@index([prescriptionNumber])
}

model Branch {
  id          Int       @id @default(autoincrement()) @map("id")
  name        String    @db.VarChar(255)
  address     String?   @db.VarChar(500)
  phone       String?   @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  customers     Customer[]
  prescriptions Prescription[]
  users         User[]

  @@map("branches")
}

model Optometrist {
  id          Int       @id @default(autoincrement()) @map("id")
  name        String    @db.VarChar(255)
  licenseNumber String? @map("license_number") @db.VarChar(255)
  phone       String?   @db.VarChar(255)
  email       String?   @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  prescriptions Prescription[]

  @@map("optometrists")
}

model Employee {
  id          Int       @id @default(autoincrement()) @map("id")
  name        String    @db.VarChar(255)
  employeeId  String?   @unique @map("employee_id") @db.VarChar(255)
  phone       String?   @db.VarChar(255)
  email       String?   @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("employees")
}

model Campaign {
  id          Int       @id @default(autoincrement()) @map("id")
  name        String    @db.VarChar(255)
  description String?   @db.Text
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("campaigns")
}

model User {
  id            Int       @id @default(autoincrement()) @map("id")
  email         String    @unique @db.VarChar(255)
  password      String?   @db.VarChar(255) // Hashed password, nullable for backward compatibility
  name          String    @db.VarChar(255)
  picture       String?   @db.VarChar(500)
  isActive      Boolean   @default(true) @map("is_active")
  isApproved    Boolean   @default(false) @map("is_approved")
  branchId      Int?      @map("branch_id")
  role          String    @default("employee") @db.VarChar(50) // "admin", "employee", "manager"
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  branch        Branch?   @relation(fields: [branchId], references: [id])
  auditLogs     AuditLog[]

  @@map("users")
  @@index([email])
  @@index([branchId])
}

model AuditLog {
  id          Int       @id @default(autoincrement()) @map("id")
  userId      Int       @map("user_id")
  action      String    @db.VarChar(100) // "create", "update", "delete", "view", "login", "logout"
  entityType  String    @db.VarChar(50) // "customer", "prescription", "branch", etc.
  entityId    Int?      @map("entity_id")
  description String?   @db.Text
  metadata    Json?     // Additional data about the action
  ipAddress   String?   @map("ip_address") @db.VarChar(45)
  userAgent   String?   @map("user_agent") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

